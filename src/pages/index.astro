---
import Layout from "@layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import { SITE, SITE_TITLE, SITE_DESCRIPTION } from "../consts";

const allStories = (await getCollection("stories"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const stories = allStories.slice(0, SITE.NUM_POSTS_ON_HOMEPAGE);

// Extract all unique tags and count occurrences
interface TagCounts {
  [key: string]: number;
}

const tagCounts = allStories.reduce((acc: TagCounts, post) => {
  if (post.data.tags) {
    post.data.tags.forEach((tag) => {
      if (!acc[tag]) {
        acc[tag] = 0;
      }
      acc[tag]++;
    });
  }
  return acc;
}, {} as TagCounts);

// Convert to array and sort alphabetically
const sortedTags = Object.entries(tagCounts)
  .map(([tag, count]) => ({ tag, count }))
  .sort((a, b) => a.tag.localeCompare(b.tag));
---

<Layout title={SITE_TITLE} description={SITE_DESCRIPTION}>

  <div class="post">
    <h1 class="post-title">About</h1>
    <div class="post-intro">
      <p><em>Bienvenue, mes amis! I've always loved writing, and traveling, and talking
            to people of all walks of life. I realized I had many stories that I've
            polished over the years, and decided to write them down. My memory may
            be hazy, and I've changed some names and places for privacy reasons,
            but I promise they're Mostly True. As true as the size of the fish I
            caught last week.
            </em></p>
    </div>


  <section class="home-section">
    <h2 class="home-section-title">Latest stories</h2>

          <div class="story-list">
            {
              stories.map((post) => (
                <div class="story-chapter">
                  <a href={`/${post.collection}/${post.id}`} class="story-link">
                    <div class="story-header">
                      <h3 class="story-title">{post.data.title}</h3>
                      <div class="story-line"></div>
                      <time class="story-date">
                        {new Date(post.data.date).toLocaleDateString(
                          "en-UK",
                          {
                            month: "short",
                            day: "numeric",
                            year: "numeric",
                          },
                        )}
                      </time>
                    </div>
                    {post.data.description && (
                      <p class="story-description">{post.data.description}</p>
                    )}
                  </a>
                </div>
              ))
            }
          </div>
        </section>

    <section class="home-section">
      <h2 class="home-section-title">Browse by Tag</h2>
      <div class="tags-grid">
        {
          sortedTags.map((tagInfo) => (
            <a href={`/tags/${tagInfo.tag}`} class="tag-item">
              <span class="tag-name">{tagInfo.tag}</span>
              <span class="tag-count">{tagInfo.count}</span>
            </a>
          ))
        }
      </div>
    </section>

    <section class="home-section">
      <h2 class="home-section-title">Let's Connect</h2>

        <p>
          If you want to get in touch with me about something, tell a story, or just to say
          hi, reach out on social media or send me an email! I'm near
          Geneva, Switzerland, mostly these days if a coffee or a beer is more your style.
        </p>
    </section>

    </div>

  <style>
    .story-list {
      display: flex;
      flex-direction: column;
      gap: var(--s2);
    }

    .story-chapter {
      width: 100%;
    }

    .story-link {
      display: block;
      text-decoration: none;
      color: var(--color-text);
      padding: var(--s1);
      border-radius: var(--s-1);
      transition: background-color 0.2s ease;
    }

    .story-link:hover {
      background-color: var(--color-background-muted);
    }

    .story-header {
      display: flex;
      align-items: center;
      width: 100%;
      margin-bottom: var(--s0);
    }

    .story-title {
      font-size: var(--s1);
      margin: 0;
      padding-right: var(--s1);
      white-space: nowrap;
    }

    .story-line {
      flex-grow: 1;
      height: 1px;
      border-top: 1px dashed var(--color-text-muted);
      margin: 0 var(--s0);
    }

    .story-date {
      font-size: var(--s-1);
      color: var(--color-text-muted);
      white-space: nowrap;
    }

    .story-description {
      font-size: var(--s0);
      color: var(--color-text-alt);
      margin: 0;
      padding-left: var(--s1);
    }

    @media (max-width: 768px) {
      .story-header {
        flex-wrap: wrap;
      }
      
      .story-title {
        width: 100%;
        white-space: normal;
        padding-right: 0;
        margin-bottom: var(--s-2);
      }
      
      .story-line {
        order: 2;
        flex-grow: 1;
      }
      
      .story-date {
        order: 3;
      }
    }
  </style>
</Layout>
